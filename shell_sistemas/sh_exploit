#!/bin/sh

shell=$1
RED='\e[31m'
GREEN='\e[32m'
NORMAL='\e[0m'

usage() {
    echo "----- SH-EXPLOIT V.2 ------"
    echo "This script tests a shell implementation using various commands."
    echo "To use this script, provide the path to the shell executable as a command-line argument."
    echo "  Usage: $0 <path-to-shell-executable>"
    exit 1
}

check () {

	test_id=$1
	cmd=$2
	expected_output=$3

	echo ${cmd} | $shell > /dev/null
	if [ $? -ne 0 ]; then
		echo "${RED}-> [$test_id]: EXIT STATUS FAILURE${NORMAL}"
		return
	fi

	echo ${cmd} | $shell | grep -E -e "$expected_output" > /dev/null
	if [ $? -ne 0 ]; then
		echo "${RED}-> [$test_id]: FAILURE, OUTPUT INVALID${NORMAL}"
		echo "${RED}-> Exception: Searching for token $expected_output${NORMAL}"
		echo "${RED}-> Input: ${cmd}${NORMAL}"
		echo "${RED}-> But output was:${NORMAL}"
		echo ${cmd} | $shell 
		return
	else
		echo "${GREEN}-> [$test_id]: SUCCESS${NORMAL}"
	fi
}

if [ $# -ne 1 ]; then
    usage
fi

echo "----- TESTING SHELL -----" 
check 'TEST 1' 'echo hola' 'hola'
check 'TEST 2' 'echo [TEST 1]' 'TEST'
check 'TEST 3' 'echo [TEST 2] | grep T' 'TEST'
check 'TEST 4' 'echo [TEST 3]|grep T' 'TEST'
check 'TEST 5' 'echo [TEST 4] |grep T' 'TEST'
check 'TEST 6' 'echo [TEST 5]| grep T' 'TEST'
check 'TEST 7' 'echo [TEST 6]|grep T|grep T' 'TEST'
echo "[PIPELINES TESTS PASSED]" 

check 'TEST 8' 'sleep 1' '.*'
check 'TEST 9' 'sleep 1 &' '.*'
echo "[BACKGROUND TESTS PASSED]" 

check 'TEST 10' 'cat | grep A < sh_exploit_file' '.*'
check 'TEST 11' 'cat | grep A > sh_exploit_output_file' '.*'
check 'TEST 12' 'cat | grep A < sh_exploit_file > sh_exploit_output_file' '.*'
check 'TEST 13' 'cat | grep A > sh_exploit_output_file < sh_exploit_file ' '.*'
check 'TEST 14' 'cat|grep A > sh_exploit_output_file < sh_exploit_file ' '.*'
echo "[REDIRECTION TESTS PASSED]" 

check 'TEST 15' "a=[TEST]\necho \$a " 'T'
check 'TEST 16' "a=[TEST]\necho \$a|grep T" 'T'
check 'TEST 17' "a=[TEST]\nenv | grep \$a" 'T'
echo "[ENVIROMENTAL ASSIGNATION TESTS PASSED]" 

check 'TEST 18' "mkdir -p testing_dir\ncd testing_dir\ntouch a.txt a.tx a.t\nls" 'a\.txt'
check 'TEST 19' "rm -rf testing_dir" '.*'
check 'TEST 20' "cd\npwd" 'home'
echo "[DIRECTORY NAVIGATION TESTS PASSED]" 

check 'TEST 21' 'rm -rf ./testing_dir/a.*' '.*'
check 'TEST 22' 'rm -rf ./testing_d.*' '.*'
echo "[GLOBBING TESTS PASSED]" 

check 'TEST 23' "echo hola\nifok echo PASS" 'PASS'
check 'TEST 24' "echo hola\nifok echo PASS | grep A" 'PASS'
check 'TEST 25' "false\nifnot echo PASS | grep A" 'PASS'
echo "[COMPARATIONS TESTS PASSED]" 

check 'TEST 26' "cd /\na=los*\necho \$a|grep lost| tr l L" 'Lost'
echo "[HARDENING TESTS PASSED]" 

exit 0

